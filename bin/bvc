#! /usr/bin/env sh
set -eu

PROGNAME=$0
SCRIPT_DIR=$(cd -- "$(dirname -- "$0")" 2>/dev/null && pwd)

# shellcheck disable=SC1091
. "${SCRIPT_DIR}/private/shFunctions"

# Load layered config (ENV > CWD/*.bvc > $BVC_CONF_DIR/bvc/bvc_defaults > bundled > safety net)
load_bvc_config

setup_traps
start_banner "$@"
information_banner "BenjaVision Catalyst Toolkit"

# ---------------------------------------------------------
# GSDevKit detection
# ---------------------------------------------------------
gsdevkit_installed() {
  command -v versionReport.solo >/dev/null 2>&1 || return 1
  [ -n "${STONES_HOME:-}" ] && [ -d "$STONES_HOME" ] || return 1
}

ensure_gsdevkit() {
  if gsdevkit_installed; then
    information_banner "GSDevKit found (STONES_HOME=${STONES_HOME:-unset})."
  else
    information_banner "GSDevKit not found — bootstrapping…"
    "${SCRIPT_DIR}/setupGsDevKit_stones.sh"
  fi
}

# ---------------------------------------------------------
# Registry existence (use tool exit status)
# ---------------------------------------------------------
registry_exists() {
  name="$1"
  registryReport.solo --registry="$name" >/dev/null 2>&1
}

# ---------------------------------------------------------
# ensure_init: make sure GSDevKit is installed AND the registry exists
# ---------------------------------------------------------
ensure_init() {
  reg="$1"
  ensure_gsdevkit
  if registry_exists "$reg"; then
    information_banner "GsDevKit registry '${reg}' already exists."
  else
    information_banner "Initializing registry '${reg}'…"
    "${SCRIPT_DIR}/initRegistry.sh" "$reg"
  fi
}

# ---------------------------------------------------------
# Commands
# ---------------------------------------------------------
cmd_init() {
  # Parse args: allow --registry anywhere; or a single positional.
  registryName="${DEFAULT_REGISTRY}"
  pos_seen=0
  while [ $# -gt 0 ]; do
    case "$1" in
      --registry=*) registryName=${1#*=} ;;
      --*)  error_banner "Unknown option: $1"; print_help; exit 1 ;;
      *)
        if [ $pos_seen -eq 0 ]; then
          registryName="$1"; pos_seen=1
        else
          error_banner "Too many arguments to 'init'. Provide at most one registry name."
          print_help; exit 1
        fi
        ;;
    esac
    shift
  done

  ensure_init "$registryName"
  exit_0_banner "init complete"
}

cmd_createDevStone() {
  # Parse everything first (flags can appear anywhere)
  registryName="${DEFAULT_REGISTRY}"
  gemStoneVersion=""
  stoneName=""

  while [ $# -gt 0 ]; do
    case "$1" in
      --registry=*) registryName=${1#*=} ;;
      --*)  error_banner "Unknown option: $1"; print_help; exit 1 ;;
      *)
        # First positional is stoneName, second is optional gemStoneVersion
        if [ -z "$stoneName" ]; then
          stoneName="$1"
        elif [ -z "$gemStoneVersion" ]; then
          gemStoneVersion="$1"
        else
          error_banner "Too many arguments."
          print_help; exit 1
        fi
        ;;
    esac
    shift
  done

  # Apply defaults (from layered config):
  if [ -z "$stoneName" ] && [ -z "$gemStoneVersion" ]; then
    stoneName="${GEMSTONE_STONE_NAME}"
    gemStoneVersion="${GEMSTONE_VERSION}"
  elif [ -n "$stoneName" ] && [ -z "$gemStoneVersion" ]; then
    gemStoneVersion="${GEMSTONE_VERSION}"
  elif [ -n "$stoneName" ] && [ -n "$gemStoneVersion" ]; then
    : # ok
  else
    error_banner "Invalid arguments to createDevStone."
    print_help; exit 1
  fi

  ensure_init "$registryName"

  "${SCRIPT_DIR}/createDevStone.sh" \
    --registry="$registryName" \
    "$stoneName" "$gemStoneVersion"

  exit_0_banner "createDevStone complete"
}

cmd_j4p() {
  # Install/update J4P if needed
  "${SCRIPT_DIR}/setupJ4P.sh"

  j4p_dir="$(abs_from_cwd "${J4P_INSTALL_DIR}")"
  if [ ! -d "$j4p_dir" ]; then
    error_banner "J4P install directory not found: $j4p_dir"
    exit 1
  fi

  # Point ROWAN_PROJECTS_HOME at the dev_tools set dir
  # (uses helper from shFunctions; sets + exports ROWAN_PROJECTS_HOME)
  rowan_home="$(abs_from_cwd "${PROJECTS_ROOT}/dev_tools")"

  information_banner "Launching J4P from ${j4p_dir} (ROWAN_PROJECTS_HOME=${rowan_home})"
  (
    cd "$j4p_dir"
    ROWAN_PROJECTS_HOME="$rowan_home" ./pharo-ui --
  )
}

cmd_gt() {
  "${SCRIPT_DIR}/setupGT.sh"

  gt_dir="$(abs_from_cwd "${GT_INSTALL_DIR}")"

  if [ ! -d "$gt_dir" ]; then
    error_banner "GT install directory not found: $gt_dir"
    exit 1
  fi

  case "$(uname -s)" in
    Darwin)
      exe_path="${gt_dir}/${GT_APP_NAME}.app/Contents/MacOS/GlamorousToolkit-cli"
      ;;
    Linux|*MINGW*|*MSYS*|*CYGWIN*)
      exe_path="${gt_dir}/bin/GlamorousToolkit-cli"
      ;;
    *)
      error_banner "Unsupported platform for GT launch"
      exit 1
      ;;
  esac

  if [ ! -x "$exe_path" ]; then
    error_banner "GT executable not found: $exe_path"
    exit 1
  fi

  image_file="${GT_APP_NAME}.image"

  information_banner "Launching GT from ${exe_path} with image ${image_file} (background)"
  (
    cd "$gt_dir"
    nohup "$exe_path" --interactive "$image_file" >/dev/null 2>&1 &
    disown
  )
}

cmd_setup() {
  # Daily setup: ensure GSDevKit + registry, create dev stone, install GT + J4P.
  # Same arg pattern as createDevStone: [--registry=NAME] [stoneName [gemstoneVersion]]
  registryName="${DEFAULT_REGISTRY}"
  gemStoneVersion=""
  stoneName=""

  while [ $# -gt 0 ]; do
    case "$1" in
      --registry=*) registryName=${1#*=} ;;
      --*)  error_banner "Unknown option: $1"; print_help; exit 1 ;;
      *)
        if [ -z "$stoneName" ]; then
          stoneName="$1"
        elif [ -z "$gemStoneVersion" ]; then
          gemStoneVersion="$1"
        else
          error_banner "Too many arguments."
          print_help; exit 1
        fi
        ;;
    esac
    shift
  done

  # Defaults for omitted args
  if [ -z "$stoneName" ] && [ -z "$gemStoneVersion" ]; then
    stoneName="${GEMSTONE_STONE_NAME}"
    gemStoneVersion="${GEMSTONE_VERSION}"
  elif [ -n "$stoneName" ] && [ -z "$gemStoneVersion" ]; then
    gemStoneVersion="${GEMSTONE_VERSION}"
  elif [ -n "$stoneName" ] && [ -n "$gemStoneVersion" ]; then
    : # ok
  else
    error_banner "Invalid arguments to setup."
    print_help; exit 1
  fi

  information_banner "Setup: registry=${registryName} stone=${stoneName} version=${gemStoneVersion}"

  # 1) Ensure environment (GSDevKit + registry)
  ensure_init "$registryName"

  # 2) Create / verify dev stone
  "${SCRIPT_DIR}/createDevStone.sh" \
    --registry="$registryName" \
     "$stoneName" "$gemStoneVersion"

  # 3) Install GT and J4P (idempotent)
  "${SCRIPT_DIR}/setupGT.sh"
  "${SCRIPT_DIR}/setupJ4P.sh"

  exit_0_banner "setup complete"
}

print_help() {
  cat <<EOF
Usage: $(prog_basename "$PROGNAME") <command> [args]

Commands:
  init [--registry=NAME | registryName]
      Ensure GSDevKit is installed and the registry exists.
      Default registry: ${DEFAULT_REGISTRY}

  createDevStone [--registry=NAME] [stoneName [gemstoneVersion]]
      Ensure environment is ready, then create a development stone.
      Defaults when not provided:
        stone=${GEMSTONE_STONE_NAME}
        version=${GEMSTONE_VERSION}
        registry=${DEFAULT_REGISTRY}

  j4p
      Run setupJ4P.sh (idempotent) and then launch the J4P IDE.

  gt
      Run setupGT.sh (idempotent) and then launch Glamorous Toolkit.

  setup [--registry=NAME] [stoneName [gemstoneVersion]]
      Daily setup: ensure env, create dev stone, install GT and J4P.
      Uses the same defaults as createDevStone.

Examples:
  bvc init
  bvc init --registry=myReg
  bvc init myReg

  bvc createDevStone
  bvc createDevStone myStone
  bvc createDevStone myStone 3.7.4.3
  bvc createDevStone --registry=myReg
  bvc createDevStone --registry=myReg myStone
  bvc createDevStone myStone 3.7.4.3 --registry=myReg

  bvc j4p
  bvc devkit
  bvc setup
  bvc setup myStone
  bvc setup --registry=myReg myStone 3.7.4.3

Notes:
- Config precedence: ENV > CWD/*.bvc > \$BVC_CONF_DIR/bvc/bvc_defaults > bundled > safety net.
- Edit defaults in your active conf root (e.g. ./conf/bvc/bvc_defaults).
- Env overrides: e.g. DEFAULT_REGISTRY=myReg bvc init
- Steps are idempotent: already-done work is skipped; later sections still run.
EOF
}

# ---------------------------------------------------------
# Dispatch
# ---------------------------------------------------------
if [ $# -gt 0 ]; then
  cmd=$1; shift
else
  cmd=help
fi

case "$cmd" in
  init)            cmd_init "$@" ;;
  createDevStone)  cmd_createDevStone "$@" ;;
  j4p)             cmd_j4p "$@" ;;
  devkit)          cmd_gt "$@" ;;
  setup)           cmd_setup "$@" ;;
  help|--help|-h)  print_help; exit 0 ;;
  *)               error_banner "Unknown command: $cmd"; print_help; exit 1 ;;
esac